# CATERINGMANAGEMENT (Desktop)

Developer README — how to run and debug the WPF desktop application.

---

## Overview

This is a WPF desktop application (C# / .NET 8) for managing catering reservations and generating documents (PDFs). It uses Supabase for authentication/data and an optional Gmail SMTP fallback for sending emails.

## Prerequisites

- .NET 8 SDK installed: https://dotnet.microsoft.com/en-us/download/dotnet/8.0
- Visual Studio 2022/2023 (recommended) with WPF/.NET desktop workload, or Visual Studio Code with C# extension.
- (Optional) A Supabase project and credentials for authentication/data access.
- (Optional) Gmail account with 2FA and an App Password if you want SMTP fallback email sending.

## Repository

Clone the repository:

```bash
git clone https://github.com/Johnravee/CATERINGMANAGEMENT.git
cd CATERINGMANAGEMENT
```

## Required Environment Variables

The app reads configuration from environment variables. Set these before running the app (or configure them in your IDE's run profile):

- `SUPABASE_URL` — your Supabase project URL (e.g. `https://xyz.supabase.co`)
- `SUPABASE_API_KEY` — Supabase anon (client) API key
- `SERVICE_ROLE_KEY` — Supabase service role key (used for admin `generate_link` fallback)
- `GMAIL` — sender Gmail address used by the fallback EmailService (e.g. `no-reply@example.com`)
- `GMAIL_PASSWORD` — Gmail App Password (NOT account password)
- `APP_URI_SCHEME` — (optional) custom URI scheme used for deep links (e.g. `cater://reset-password`)
- `PASSWORD_RESET_BRIDGE_URL` — (optional) URL to web bridge used for mobile redirects
- `MOBILE_REDIRECT_URI` — (optional) mobile redirect URI

Notes:
- For local development on Windows you can set environment variables in PowerShell (session-only):

```powershell
$env:SUPABASE_URL = "https://your.supabase.co"
$env:SUPABASE_API_KEY = "your_anon_key"
$env:SERVICE_ROLE_KEY = "your_service_role_key"
$env:GMAIL = "your-sender@gmail.com"
$env:GMAIL_PASSWORD = "your_app_password"
```

To set persistent user environment variables, use `setx` or the System Properties > Environment Variables UI.

## Build & Run

Open the solution `CATERINGMANAGEMENT.csproj` in Visual Studio and select the `Debug` configuration.

- From Visual Studio: Press F5 to build and run.
- From command line:

```bash
dotnet build
dotnet run --project CATERINGMANAGEMENT.csproj
```

Note: WPF apps are typically launched with Visual Studio. Running `dotnet run` from the CLI will also start the app if the project is the startup project.

## Registering the Custom URI Protocol (optional)

The app includes a helper `UriProtocolRegistrar` that registers a custom protocol (e.g. `cater://`) so password reset deep links can open the desktop app. The app attempts to register the protocol on startup using the executable path. You can also register the protocol manually if required.

## Logs

During Debug builds the app writes logs to a `Logs` folder in the app working directory. Check `Logs/YYYY-MM-DD.log` for diagnostic information (requests, errors, and email send attempts).

## Password Reset / Forgot Password Flow (troubleshooting)

If users report that the password reset email is not arriving, verify the following in order:

1. Ensure `SUPABASE_URL` and `SUPABASE_API_KEY` are set and valid.
2. The app first calls Supabase `/auth/v1/recover` endpoint (using anon key). If Supabase succeeds, it will send email directly.
3. If the REST recover fails (or Supabase is configured not to send email), the app falls back to the admin `generate_link` endpoint which requires `SERVICE_ROLE_KEY`. Ensure this is set and correct.
4. If `generate_link` returns an `action_link`, the app attempts to send the email using `EmailService` (Gmail SMTP). For SMTP:
   - `GMAIL` must be set to a valid sending address.
   - `GMAIL_PASSWORD` must be an App Password generated from the Google Account (2FA required).
   - Confirm Google account allows SMTP via the used credentials.
5. Check the `Logs` file for messages emitted by `AuthService` and `EmailService`. The code logs REST responses and SMTP exceptions in Debug builds.

If you want to manually test SMTP, you can create a small console snippet that uses `EmailService.SendEmailAsync` to confirm credentials and connectivity.

## PDF Generation

PDFs are generated by `DocumentsGenerator` classes using PdfSharp. No external service required. The Save dialog will prompt for a filename when a PDF is created.

## Common Tasks

- Reset database or seed data: not included in this repository. Use Supabase UI or scripts you maintain.
- Change Supabase keys: update environment variables and restart the app.
- Enable verbose debugging: run Visual Studio in Debug configuration (debug logging writes to `Logs` folder).

## Contributing

1. Create a feature branch: `git checkout -b feat/my-change`
2. Make changes and commit: `git commit -m "feat: ..."`
3. Push and open a PR.

## Useful Files

- `Services/AuthService.cs` — Supabase authentication and password recovery flow.
- `Services/EmailService.cs` — SMTP fallback email sender.
- `ViewModels/AuthVM/ResetPasswordRequestViewModel.cs` — UI viewmodel that triggers password reset.
- `DocumentsGenerator/ReservationChecklistPdfGenerator.cs` — PDF checklist generation.

---

If you want, I can also:
- Add a `env.example` file with placeholder keys.
- Add a small diagnostic window to test email sending from the app.
- Add a script to set environment variables for Windows development.